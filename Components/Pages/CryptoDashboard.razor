@page "/"
@using CryptoMonitor.Models
@using CryptoMonitor.Services
@inject ICryptoService CryptoService
@inject ITrendService TrendService
@inject ILanguageService Lang
@inject IJSRuntime JS
@implements IDisposable
@rendermode InteractiveServer

<div class="container fade-in">
    <header class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>@Lang.T("AppTitle")</h1>
            <p class="subtitle">@Lang.T("AppSubtitle")</p>
        </div>
        <div class="lang-switcher">
            <button class="btn btn-outline-info btn-sm @(Lang.CurrentLanguage == Language.ENG ? "active" : "")" @onclick='() => SetLanguage(Language.ENG)'>ENG</button>
            <button class="btn btn-outline-info btn-sm @(Lang.CurrentLanguage == Language.PT ? "active" : "")" @onclick='() => SetLanguage(Language.PT)'>PT</button>
        </div>
    </header>

    <MacroCard Insight="@macroInsight" />

    <TrendGrid Trends="@trends" />

    <div class="search-container">
        <div class="d-flex align-items-center">
            <input type="text" class="glass-input" placeholder="@Lang.T("FilterPlaceholder")" @bind="searchTerm" @bind:event="oninput" />
            @if (assets.Any())
            {
                <span class="ms-3 badge border border-info text-info">
                    @assets.Count @Lang.T("Asset")s (@assets.FirstOrDefault()?.Provider)
                </span>
            }
        </div>
        <button class="refresh-btn" @onclick="LoadData">
            <i class="bi bi-arrow-clockwise"></i> @Lang.T("UpdateBtn")
        </button>
    </div>

    @if (!isLoading && !assets.Any())
    {
        <div class="text-center py-5 glass-card">
            <i class="bi bi-exclamation-triangle text-warning display-4"></i>
            <h3 class="mt-3">@Lang.T("NoDataTitle")</h3>
            <p class="text-secondary">@Lang.T("NoDataDesc")</p>
            <button class="btn btn-outline-info mt-3" @onclick="LoadData">
                <i class="bi bi-arrow-clockwise"></i> @Lang.T("RetryBtn")
            </button>
        </div>
    }
    else
    {
        <AssetTable CryptoAssets="@assets" SearchTerm="@searchTerm" IsLoading="@isLoading" />
    }
</div>

@code {
    private List<CryptoAsset> assets = new();
    private List<MarketTrend> trends = new();
    private MacroInsight? macroInsight;
    private string searchTerm = "";
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        Lang.OnLanguageChanged += HandleLanguageChanged;
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var countryCode = await JS.InvokeAsync<string>("getCountryCode");
                if (!string.IsNullOrEmpty(countryCode))
                {
                    Lang.SetLanguageByCountry(countryCode);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[DEBUG] Auto-language detection failed: {ex.Message}");
            }
        }
    }

    private async void HandleLanguageChanged()
    {
        await LoadData();
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Lang.OnLanguageChanged -= HandleLanguageChanged;
    }

    private void SetLanguage(Language language)
    {
        Lang.SetLanguage(language);
    }

    private async Task LoadData()
    {
        isLoading = true;
        var fetchAssets = CryptoService.GetTop100AssetsAsync();
        var fetchTrends = TrendService.GetCurrentTrendsAsync();
        var fetchMacro = TrendService.GetMacroInsightsAsync();

        await Task.WhenAll(fetchAssets, fetchTrends, fetchMacro);

        assets = await fetchAssets;
        trends = await fetchTrends;
        macroInsight = await fetchMacro;
        isLoading = false;
    }
}

<style>
    .text-accent { color: var(--accent-color); }
    .fade-in { animation: fadeIn 0.8s ease-in-out; }
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .badge.bg-success { background-color: var(--up-color) !important; color: black !important; }
    .badge.bg-danger { background-color: var(--down-color) !important; }
    .mb-5 { margin-bottom: 3rem !important; }

    .lang-switcher .btn {
        margin-left: 5px;
        border-color: rgba(0, 255, 204, 0.3);
        color: var(--accent-color);
    }
    .lang-switcher .btn.active {
        background-color: var(--accent-color);
        color: black;
    }
</style>
