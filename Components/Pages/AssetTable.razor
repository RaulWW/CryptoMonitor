@using CryptoMonitor.Models
@using CryptoMonitor.Services
@using System.Globalization
@inject ILanguageService Lang

<div class="table-responsive" style="position: relative;">
    @if (IsLoading)
    {
        <div class="table-loading-overlay">
            <div class="spinner-border text-info" role="status"></div>
        </div>
    }
    <table class="glass-list @(IsLoading ? "opacity-50" : "")">
        <thead>
            <tr>
                <th @onclick='() => Sort("rank")'>@Lang.T("Rank") @GetSortIcon("rank")</th>
                <th @onclick='() => Sort("name")'>@Lang.T("Asset") @GetSortIcon("name")</th>
                <th @onclick='() => Sort("price")'>@Lang.T("Price") @GetSortIcon("price")</th>
                <th @onclick='() => Sort("1h")'>@Lang.T("1h") @GetSortIcon("1h")</th>
                <th @onclick='() => Sort("24h")'>@Lang.T("24h") @GetSortIcon("24h")</th>
                <th @onclick='() => Sort("7d")'>@Lang.T("7d") @GetSortIcon("7d")</th>
                <th @onclick='() => Sort("cap")'>@Lang.T("MarketCap") @GetSortIcon("cap")</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var asset in FilteredAssets)
            {
                @try
                {
                    <tr>
                        <td>@asset.MarketCapRank</td>
                        <td>
                            <div class="crypto-name">
                                <img src="@asset.Image" class="crypto-logo" alt="@asset.Name" onerror="this.src='favicon.png'" />
                                <div>
                                    <div class="fw-bold">@asset.Name</div>
                                    <div class="small text-secondary">@asset.Symbol.ToUpper()</div>
                                </div>
                            </div>
                        </td>
                        <td class="fw-bold">@asset.CurrentPrice.ToString("C2", CultureInfo.CreateSpecificCulture("en-US"))</td>
                        <td class="@GetPriceClass(asset.PriceChange1h)">
                            <div>@(asset.PriceChange1h?.ToString("N2") ?? "---")%</div>
                            <div class="small opacity-75">@FormatAbsoluteChange(asset.CurrentPrice, asset.PriceChange1h)</div>
                        </td>
                        <td class="@GetPriceClass(asset.PriceChange24h)">
                            <div>@asset.PriceChange24h.ToString("N2")%</div>
                            <div class="small opacity-75">@FormatAbsoluteChange(asset.CurrentPrice, asset.PriceChange24h)</div>
                        </td>
                        <td class="@GetPriceClass(asset.PriceChange7d)">
                            <div>@(asset.PriceChange7d?.ToString("N2") ?? "---")%</div>
                            <div class="small opacity-75">@FormatAbsoluteChange(asset.CurrentPrice, asset.PriceChange7d)</div>
                        </td>
                        <td class="text-secondary">@asset.MarketCap.ToString("N0", CultureInfo.CreateSpecificCulture("en-US"))</td>
                    </tr>
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[ERROR] Error rendering asset: {ex.Message}");
                }
            }
        </tbody>
    </table>
</div>

@code {
    [Parameter] public List<CryptoAsset> CryptoAssets { get; set; } = new();
    [Parameter] public string SearchTerm { get; set; } = "";
    [Parameter] public bool IsLoading { get; set; } = false;

    private string sortColumn = "rank";
    private bool sortAscending = true;

    private IEnumerable<CryptoAsset> FilteredAssets
    {
        get
        {
            var result = CryptoAssets.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(SearchTerm))
            {
                result = result.Where(a => a.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) || 
                                           a.Symbol.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));
            }

            return ApplySort(result);
        }
    }

    private IEnumerable<CryptoAsset> ApplySort(IEnumerable<CryptoAsset> query)
    {
        if (sortAscending)
        {
            return sortColumn switch
            {
                "rank" => query.OrderBy(a => a.MarketCapRank),
                "name" => query.OrderBy(a => a.Name),
                "price" => query.OrderBy(a => a.CurrentPrice),
                "1h" => query.OrderBy(a => a.PriceChange1h ?? -999999),
                "24h" => query.OrderBy(a => a.PriceChange24h),
                "7d" => query.OrderBy(a => a.PriceChange7d ?? -999999),
                "cap" => query.OrderBy(a => a.MarketCap),
                _ => query.OrderBy(a => a.MarketCapRank)
            };
        }
        else
        {
            return sortColumn switch
            {
                "rank" => query.OrderByDescending(a => a.MarketCapRank),
                "name" => query.OrderByDescending(a => a.Name),
                "price" => query.OrderByDescending(a => a.CurrentPrice),
                "1h" => query.OrderByDescending(a => a.PriceChange1h ?? -999999),
                "24h" => query.OrderByDescending(a => a.PriceChange24h),
                "7d" => query.OrderByDescending(a => a.PriceChange7d ?? -999999),
                "cap" => query.OrderByDescending(a => a.MarketCap),
                _ => query.OrderByDescending(a => a.MarketCapRank)
            };
        }
    }

    private void Sort(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
    }

    private string GetPriceClass(double? change) => (change ?? 0) >= 0 ? "price-up" : "price-down";

    private string GetSortIcon(string column)
    {
        if (sortColumn != column) return "";
        return sortAscending ? "▲" : "▼";
    }

    private string FormatAbsoluteChange(decimal currentPrice, double? percentageChange)
    {
        if (percentageChange == null || Math.Abs(percentageChange.Value + 100.0) < 0.0001) return "";
        
        // Calculation: OldPrice = CurrentPrice / (1 + (percentage / 100))
        // Change = CurrentPrice - OldPrice
        decimal pc = (decimal)(percentageChange.Value / 100.0);
        decimal oldPrice = currentPrice / (1 + pc);
        decimal diff = currentPrice - oldPrice;
        
        return (diff >= 0 ? "+" : "") + diff.ToString("C2", CultureInfo.CreateSpecificCulture("en-US"));
    }
}
